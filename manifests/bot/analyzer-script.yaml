apiVersion: v1
kind: ConfigMap
metadata:
  name: analyzer-script
data:
  analyze.sh: |
    #!/bin/sh
    TOKENS="BTCUSDT ETHUSDT SOLUSDT BNBUSDT DOGEUSDT"
    API_URL="http://trading-bot.default.svc.cluster.local:8000"

    for TOKEN in $TOKENS; do
      echo "Analyzing $TOKEN..."
      RESPONSE=$(curl -s "$API_URL/api/analyze?symbol=$TOKEN&interval=60")
      BIAS=$(echo "$RESPONSE" | grep -o '"bias":"[^"]*"' | head -1 | cut -d'"' -f4)
      CONFIDENCE=$(echo "$RESPONSE" | grep -o '"confidence":[0-9]*' | head -1 | cut -d':' -f2)

      if [ "$BIAS" = "BUY" ] || [ "$BIAS" = "SELL" ]; then
        echo "Signal detected: $BIAS for $TOKEN (confidence: $CONFIDENCE%)"

        REASONS=$(echo "$RESPONSE" | grep -o '"reasons":\[[^]]*\]' | head -1)
        SUBJECT="Trading Alert: $BIAS $TOKEN (${CONFIDENCE}% confidence)"
        BODY="Trading Signal Detected!\n\nToken: $TOKEN\nSignal: $BIAS\nConfidence: ${CONFIDENCE}%\nTimeframe: 1H\nTime: $(date -u)\n\nReasons:\n$REASONS"

        printf "From: Trading Bot <%s>\nTo: %s\nSubject: %s\n\n%b" \
          "$SMTP_USER" "$EMAIL_TO" "$SUBJECT" "$BODY" | \
          curl -s --url "smtps://$SMTP_HOST:$SMTP_PORT" \
            --ssl-reqd \
            --mail-from "$SMTP_USER" \
            --mail-rcpt "$EMAIL_TO" \
            --user "$SMTP_USER:$SMTP_PASS" \
            -T -

        echo "Email sent for $TOKEN"
      else
        echo "No action needed for $TOKEN (Signal: $BIAS)"
      fi
    done